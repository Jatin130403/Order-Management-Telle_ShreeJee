<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Out Of Delivery Orders â€” ShreeJee Ayucare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .order-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .order-card:hover { transform: translateY(-4px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
    .btn-blue { background:#2563eb; color:white; }
    .btn-green { background:#16a34a; color:white; }
    .btn-yellow { background:#ca8a04; color:white; }
    .btn-red { background:#dc2626; color:white; }
    .glass-card { background: rgba(255,255,255,0.9); border-radius: 12px; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

  <!-- NAV -->
  <nav class="bg-green-900 text-white sticky top-0 z-50 shadow">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <h1 class="text-xl font-semibold">Out Of Delivery Orders</h1>
      <div class="flex gap-3 items-center">
        <button id="pendingBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md shadow">
          Pending <span id="pendingCount" class="ml-2 bg-red-500 text-white rounded-full px-2 py-0.5 text-xs">0</span>
        </button>
        <button onclick="window.location.href='Order-Management.html'"
          class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md shadow">
          Back to Dashboard
        </button>
      </div>
    </div>
  </nav>

  <!-- CONTENT -->
  <main class="max-w-6xl mx-auto p-6">
    <div id="oodContainer" class="space-y-4"></div>
    <p id="noOrdersMsg" class="text-center text-gray-500 mt-10 hidden">No Out Of Delivery Currently</p>

    <!-- Pending Section -->
    <div id="pendingSection" class="hidden mt-10">
      <h2 class="text-xl font-bold text-purple-700 mb-4">ðŸ“Œ Pending OOD Follow-ups</h2>
      <div id="pendingContainer" class="space-y-4"></div>
    </div>
  </main>

  <!-- Customer Modal -->
  <div id="customerBackdrop" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl w-full max-w-4xl mx-4 shadow-2xl p-6 glass-card modal-inner">
      <div class="flex justify-between items-center mb-4">
        <h3 id="custTitle" class="text-2xl font-bold text-green-800">Customer Details</h3>
        <button id="custClose" class="text-gray-600 hover:text-gray-900" aria-label="Close">âœ•</button>
      </div>
      <div id="customerDetails" class="space-y-6"></div>
      <div class="flex justify-end mt-4">
        <button id="custClose2" class="px-5 py-2 rounded-lg bg-red-500 text-white shadow hover:bg-red-600 transition">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" style="position:fixed;bottom:1rem;right:1rem; background:rgba(0,0,0,0.85); color:#fff; padding:8px 12px; border-radius:8px; display:none; z-index:9999;"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyB1wbJonjyJQDrPJWbMCVBtRolJH4HDskU",
    authDomain: "shreejee-ayucare.firebaseapp.com",
    databaseURL: "https://shreejee-ayucare-default-rtdb.firebaseio.com",
    projectId: "shreejee-ayucare",
    storageBucket: "shreejee-ayucare.firebasestorage.app",
    messagingSenderId: "247248655859",
    appId: "1:247248655859:web:b09bfc30ff6953aad42e86"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const currentUser = JSON.parse(localStorage.getItem("currentTellicaller") || "{}");
  if (!currentUser.name) window.location.href = "index.html";

  const ordersRef = db.ref('oms_orders');
  let firebaseOrders = {};

  function showToast(msg, t=2500) {
    const td = document.getElementById('toast');
    td.textContent = msg;
    td.style.display = 'block';
    setTimeout(()=> td.style.display = 'none', t);
  }

  function safeToNumber(v){ return (v===undefined||v===null)?null:(isNaN(Number(v))?null:Number(v)); }
  function isToday(ts){ if(!ts) return false; const d=new Date(safeToNumber(ts)||ts); return d.toDateString()===new Date().toDateString(); }
  function getBtnClass(val){ if(val==="Agree") return "btn-green"; if(val==="Not Picked") return "btn-yellow"; if(val==="Refused") return "btn-red"; return "btn-blue"; }

  async function closeOrderWithType(orderId, type, remark='') {
    if (!orderId) return;
    if (type === 'RTO' && (!remark || !remark.trim())) { alert('Remark required'); return; }
    const updates = { status: 'closed', closedType: type, deliveredAt: Date.now() };
    if (type === 'RTO') updates.remark = remark.trim();
    await ordersRef.child(orderId).update(updates);
    showToast('Order closed as ' + type);
    renderOOD();
    renderPending();
  }

  function renderOOD() {
    const container = document.getElementById("oodContainer");
    const noMsg = document.getElementById("noOrdersMsg");
    container.innerHTML = "";

    let todayOOD = Object.values(firebaseOrders || {}).filter(o =>
      o && o.oodStatus === "today" && (!o.oodMarkedAt || isToday(o.oodMarkedAt)) && o.tellicaller === currentUser.name
    );

    if (!todayOOD.length) noMsg.classList.remove("hidden"); else noMsg.classList.add("hidden");

    const pendingCount = document.getElementById("pendingCount");
    if (pendingCount) {
      const pendings = Object.values(firebaseOrders || {}).filter(o =>
        o && o.oodStatus === "today" && o.oodMarkedAt && !isToday(o.oodMarkedAt) && o.status !== 'closed' && o.tellicaller === currentUser.name
      );
      pendingCount.textContent = pendings.length;
    }

    todayOOD.forEach(o => {
      const card = document.createElement("div");
      card.className = "order-card bg-white p-4 rounded shadow border";

      const left = document.createElement('div');
      left.innerHTML = `
        <h2 class="font-semibold text-lg text-blue-700">${o.firstName||''} ${o.lastName||''}</h2>
        <p class="text-sm text-gray-600">Phone: ${o.phone || '-'}</p>
        <p class="text-sm text-gray-600">Amount: â‚¹${(o.amount!=null)?Number(o.amount).toFixed(2):'0.00'}</p>
        <p class="text-sm text-gray-600">Tellecaller: ${o.tellicaller||'-'}</p>
        <p class="text-sm text-gray-600">Order ID: ${o.externalOrderId || 'Not Defined'}</p>
      `;
        const product = o.product || 'Karela Jamun Powder';
        const productPill = document.createElement('div');
        productPill.style.display = 'inline-flex';
        productPill.style.alignItems = 'center';
        productPill.style.gap = '6px';
        productPill.style.fontSize = '12px';
        productPill.style.fontWeight = '600';
        productPill.style.marginTop = '4px';
        if (product === 'Men Wellness') {
          productPill.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor" style="color:#7c3aed;width:16px;height:16px;"><path d="M12 2l3 6 6 .5-4.5 4 1 6L12 16l-5.5 2.5 1-6L3 8.5 9 8 12 2z"/></svg><span>Men Wellness</span>`;
        } else {
          productPill.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor" style="color:#10b981;width:16px;height:16px;"><path d="M7 2h10v2H7V2zm0 4h10v2H7V6zm0 4h10v9H7v-9z"/></svg><span>Karela Jamun Powder</span>`;
        }
        left.appendChild(productPill);


      const rightBtnWrap = document.createElement('div');
      rightBtnWrap.className = 'flex flex-col items-end gap-2';

      const viewBtn = document.createElement('button');
      viewBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm';
      viewBtn.textContent = 'View';
      viewBtn.addEventListener('click', (ev) => { ev.stopPropagation(); openCustomerModal(o.phone, o.orderId); });
      rightBtnWrap.appendChild(viewBtn);

      const remarkBtn = document.createElement("button");
      remarkBtn.textContent = o.oodRemark || "Call";
      remarkBtn.className = "px-3 py-1 rounded " + getBtnClass(o.oodRemark);
      remarkBtn.addEventListener('click', ()=> {
        const editor = document.createElement('div');
        editor.className = 'flex items-center gap-2 mt-3';

        const select = document.createElement('select'); select.className = 'border p-1 rounded text-sm';
        ["Agree","Not Picked","Refused"].forEach(opt=>{
          const option = document.createElement('option'); option.value = opt; option.textContent = opt;
          if ((o.oodRemark||"") === opt) option.selected = true;
          select.appendChild(option);
        });

        const saveBtn = document.createElement('button'); saveBtn.className = 'px-3 py-1 bg-green-600 text-white rounded text-sm'; saveBtn.textContent = 'Save';
        const cancelBtn = document.createElement('button'); cancelBtn.className = 'px-3 py-1 bg-gray-300 text-black rounded text-sm'; cancelBtn.textContent = 'Cancel';

        editor.appendChild(select); editor.appendChild(saveBtn); editor.appendChild(cancelBtn);
        remarkBtn.style.display = 'none';
        card.appendChild(editor);

        saveBtn.addEventListener('click', async ()=> {
          const remark = select.value;
          await ordersRef.child(o.orderId).update({ oodRemark: remark, oodLastUpdated: Date.now() });
          showToast('OOD remark saved');
          editor.remove();
          remarkBtn.textContent = remark;
          remarkBtn.className = 'px-3 py-1 rounded ' + getBtnClass(remark);
          remarkBtn.style.display = '';
          renderOOD();
        });

        cancelBtn.addEventListener('click', ()=> { editor.remove(); remarkBtn.style.display = ''; });
      });
      rightBtnWrap.appendChild(remarkBtn);

      const row = document.createElement('div');
      row.className = 'flex justify-between items-start';
      row.appendChild(left);
      row.appendChild(rightBtnWrap);
      card.appendChild(row);

      if (o.status !== 'closed') {
        const actions = document.createElement('div'); 
        actions.className = 'mt-3 flex gap-2';

        const rtoInput = document.createElement('input'); 
        rtoInput.placeholder = 'RTO Remark'; 
        rtoInput.className = 'border p-1 rounded text-sm';

        const rtoBtn = document.createElement('button'); 
        rtoBtn.className = 'px-3 py-1 bg-red-600 text-white rounded text-sm'; 
        rtoBtn.textContent = 'Mark RTO';
        rtoBtn.addEventListener('click', ()=> { 
          if (!rtoInput.value.trim()) { 
            alert('Please enter remark for RTO'); 
            return; 
          } 
          closeOrderWithType(o.orderId, 'RTO', rtoInput.value.trim()); 
        });

        actions.appendChild(rtoInput); 
        actions.appendChild(rtoBtn);
        card.appendChild(actions);
      }

      container.appendChild(card);
    });
  }

  function openCustomerModal(phone) {
    const allOrders = Object.values(firebaseOrders || {});
    const customerOrders = allOrders.filter(o => o && o.phone === phone);
    if (!customerOrders.length) { alert('No customer record found'); return; }
    const latest = customerOrders.reduce((a,b)=>( (b.timestamp||0)>(a.timestamp||0)?b:a ), customerOrders[0]);
    const cust = {
      firstName: latest.firstName || '', lastName: latest.lastName || '', phone: latest.phone || phone,
      address: latest.address || '', city: latest.city || '', state: latest.state || '', pincode: latest.pincode || ''
    };

    document.getElementById('custTitle').textContent = `Customer â€” ${cust.firstName} ${cust.lastName}`;
    const details = document.getElementById('customerDetails');
    details.innerHTML = `<div class='p-5 rounded-xl bg-gradient-to-r from-green-50 to-white shadow-md'>
      <h4 class='font-semibold text-lg mb-3 text-green-800'>ðŸ‘¤ Customer Information</h4>
      <div class='grid grid-cols-2 gap-3 text-sm text-gray-700'>
        <div><b>Phone:</b> ${cust.phone}</div><div><b>City:</b> ${cust.city}</div>
        <div><b>State:</b> ${cust.state}</div><div><b>Pincode:</b> ${cust.pincode}</div>
        <div class='col-span-2'><b>Address:</b> ${cust.address}</div></div></div>`;
    document.getElementById('customerBackdrop').style.display='flex';
  }

  function renderPending() {
    const sec = document.getElementById("pendingSection");
    const cont = document.getElementById("pendingContainer");
    cont.innerHTML = "";
    sec.classList.remove("hidden");

    let pendings = Object.values(firebaseOrders || {}).filter(o =>
      o && o.oodStatus === "today" && o.oodMarkedAt && !isToday(o.oodMarkedAt) && o.status !== 'closed' && o.tellicaller === currentUser.name
    );

    if (!pendings.length) { 
      cont.innerHTML = `<p class='text-gray-500'>No pending OOD follow-ups.</p>`; 
      return; 
    }

    pendings.forEach(o => {
      const card = document.createElement('div');
      card.className = 'order-card bg-white p-4 rounded shadow border';
      card.innerHTML = `<h2 class='font-semibold text-lg text-blue-700'>${o.firstName||''} ${o.lastName||''}</h2>
      <p class='text-sm'>Phone: ${o.phone}</p><p class='text-sm'>Tellecaller: ${o.tellicaller}</p>
      <p class='text-sm'>Remark: ${o.oodRemark||'Pending'}</p>`;
      cont.appendChild(card);
    });
  }

  ordersRef.on('value', snap => { firebaseOrders = snap.val() || {}; renderOOD(); });

  document.addEventListener('DOMContentLoaded', ()=> {
    const pendingBtn = document.getElementById('pendingBtn');
    if (pendingBtn) pendingBtn.addEventListener('click', renderPending);
    document.getElementById('custClose').addEventListener('click', ()=> document.getElementById('customerBackdrop').style.display='none');
    document.getElementById('custClose2').addEventListener('click', ()=> document.getElementById('customerBackdrop').style.display='none');
  });
  </script>
</body>
</html>

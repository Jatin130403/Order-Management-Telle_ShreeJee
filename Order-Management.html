<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Order Management â€” ShreeJee Ayucare (Tellecaller Portal â€” Updated)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Background & glass look */
    body{
      background: linear-gradient(-45deg,#065f46,#047857,#10b981,#6ee7b7);
      background-size:400% 400%;
      animation: gradientBG 12s ease infinite;
    }
    @keyframes gradientBG {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    .glass-card { background: rgba(255,255,255,0.18); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: all .18s ease; }
    .glass-card:hover { transform: translateY(-6px) scale(1.01); box-shadow: 0 18px 40px rgba(0,0,0,0.22); }
    .order-open { box-shadow: 0 0 0 3px rgba(250,180,30,0.06); }
    .status-square { width:22px; height:22px; border-radius:4px; display:inline-block; cursor:pointer; }
    .status-square.locked { cursor: not-allowed; opacity:.55; }
    .clickable { cursor:pointer; }

    /* Product badges & card styles */
    .product-karela { background: linear-gradient(90deg,#ecfdf5,#ecfeff); border-left:4px solid #10b981; }
    .product-men { background: linear-gradient(90deg,#eef2ff,#f5f3ff); border-left:4px solid #7c3aed; }
    .order-cancelled { background:#f3f4f6; border:2px solid #dc2626; }

    .product-pill { display:inline-flex; align-items:center; gap:8px; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600; }
    .product-pill svg { width:18px; height:18px; }

    /* Highlighting for RTO and Delivered orders */
    .highlight-rto { border-left: 6px solid #ef4444 !important; background: rgba(254,202,202,0.10) !important; box-shadow: 0 6px 18px rgba(239,68,68,0.06); }
    .highlight-delivered { border-left: 6px solid #10b981 !important; background: rgba(220,255,226,0.10) !important; box-shadow: 0 6px 18px rgba(16,185,129,0.06); }

    /* Status icons */
    .status-icon { width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:50%; }
    .status-icon.clickable { cursor:pointer; }
    .status-icon-undispatched { background: #f0f0f0; border: 1px solid #cfcfcf; }
    .status-icon-intransit { background: #2ecc71; }
    .status-icon-delivered { background: #2ecc71; }
    .status-icon-rto { background: #e74c3c; }

    /* small responsive tweaks */
    @media (max-width:640px){
      .w-40{ width:150px !important; }
      .search-group { flex-direction: column; gap: 8px; }
      .search-group input { width: 100% !important; }
      .search-group select { width: 100% !important; }
    }

    /* modal inner wrapper */
    .modal-inner { position: relative; }
    .modal-close-btn {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      background: rgba(255,255,255,0.95);
      border-radius: 9999px;
      padding: 6px 10px;
      font-size: 1.15rem;
      line-height: 1;
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
      border: 1px solid rgba(0,0,0,0.06);
      z-index: 60;
      cursor: pointer;
    }

    /* Scroll fix for Order History */
    #customerDetails {
      max-height: 60vh;
      overflow-y: auto;
    }
  </style>
</head>
<body class="font-sans text-gray-800 min-h-screen">

  <!-- NAV -->
  <nav class="bg-green-900/95 text-white fixed top-0 left-0 right-0 z-50 shadow-md">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="logo.jpg" alt="Logo" class="h-10 w-10 rounded-full object-cover shadow-md" onerror="this.style.display='none'">
        <div>
          <div class="font-semibold text-lg">ShreeJee Ayucare</div>
          <div id="welcomeMsg" class="text-sm text-yellow-300 font-bold"></div>
          <div class="text-xs text-green-200">Tellecaller Portal</div>
        </div>
      </div>

      <div id="navControls" class="flex flex-wrap items-center gap-3">
        <!-- New Search Group: Dropdown + Input -->
        <div class="search-group flex items-center gap-2">
          <select id="searchType" class="px-3 py-2 rounded-md border bg-white text-black shadow-sm">
            <option value="phone">Phone Number</option>
            <option value="name">Customer Name</option>
            <option value="orderId">Order ID</option>
          </select>
          <input id="searchInput" type="search" placeholder="Enter phone / name / order ID..." class="px-3 py-2 rounded-md border bg-white text-black w-64 shadow-sm" />
        </div>

        <select id="filterStatus" class="px-2 py-2 rounded-md border bg-white text-black shadow-sm">
          <option value="all">All Status</option>
          <option value="delivered">Delivered</option>
          <option value="rto">RTO</option>
          <option value="cancelled">Cancelled</option>
        </select>

        <input id="filterFrom" type="date" class="px-2 py-2 rounded-md border bg-white text-black shadow-sm" />
        <input id="filterTo" type="date" class="px-2 py-2 rounded-md border bg-white text-black shadow-sm" />

        <button id="btnAddOrder" class="bg-yellow-400 hover:bg-yellow-500 px-4 py-2 rounded-md font-semibold shadow">+ Add Order</button>
        <button onclick="window.location.href='schedule.html'" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md shadow">Schedule</button>
        <button onclick="window.location.href='out_of_delivery.html'" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md shadow flex items-center gap-2">
          Out of Delivery 
          <span id="oodBadge" class="ml-1 bg-red-500 text-white rounded-full px-2 py-0.5 text-xs">0</span>
        </button>
        <button onclick="window.location.href='History.html'" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md shadow flex items-center gap-2">
          History
        </button>
        <button id="btnLogout" onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-md font-semibold shadow text-white">Logout</button>
      </div>
    </div>
  </nav>
  <div id="headerSpacer" style="height:72px"></div>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto p-6">
    <div id="ordersContainer" class="space-y-6"></div>
    <p id="emptyMessage" class="text-center text-gray-200 mt-8 hidden">No orders found.</p>
  </main>

  <!-- Add Order Modal -->
  <div id="modalBackdrop" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg w-full max-w-2xl mx-4 shadow-lg p-6 modal-inner">
      <div class="flex justify-between items-center mb-4">
        <h3 id="modalTitle" class="text-lg font-semibold">Add Order</h3>
        <button id="modalClose" class="modal-close-btn text-gray-600 hover:text-gray-900" aria-label="Close">âœ•</button>
      </div>

      <form id="orderForm" class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <input id="firstName" class="border p-2 rounded" placeholder="First name" required />
          <input id="lastName" class="border p-2 rounded" placeholder="Last name" />
        </div>

        <div class="grid grid-cols-2 gap-3">
          <input id="phone" class="border p-2 rounded" placeholder="Phone (10 digits)" required />
          <input id="tellicaller" class="border p-2 rounded" placeholder="Order placed by (Tellicaller)" required />
        </div>

        <input id="address" class="border p-2 rounded" placeholder="Address" />
        <div class="grid grid-cols-3 gap-3">
          <input id="city" class="border p-2 rounded" placeholder="City" />
          <input id="state" class="border p-2 rounded" placeholder="State" />
          <input id="pincode" class="border p-2 rounded" placeholder="Pincode" maxlength="6" />
        </div>

        <div class="grid grid-cols-3 gap-3">
          <input id="perPrice" type="number" min="0" step="0.01" class="border p-2 rounded" placeholder="Per Price (Single Piece)" required />
          <input id="quantity" type="number" min="1" step="1" class="border p-2 rounded" placeholder="Quantity" value="1" required />
          <input id="amount" type="number" min="0" step="0.01" class="border p-2 rounded" placeholder="Total Amount" required readonly />
        </div>

        <div class="grid grid-cols-3 gap-3 items-center">
          <select id="statusSelect" class="border p-2 rounded">
            <option value="open">Open</option>
            <option value="dispatched">Dispatched</option>
          </select>
          <input id="scheduledDate" type="date" class="border p-2 rounded" title="Choose a date to schedule this order (defaults to today)" />
          <select id="productSelect" class="border p-2 rounded">
            <option value="Karela Jamun Powder">ðŸŸ¢ Karela Jamun Powder</option>
            <option value="Men Wellness">ðŸŸ£ Men Wellness</option>
          </select>
        </div>

        <div class="flex justify-end gap-3 pt-2">
          <button type="button" id="btnCancel" class="px-4 py-2 rounded border">Cancel</button>
          <button type="submit" id="btnSaveOrder" class="px-4 py-2 rounded bg-green-700 text-white">Save Order</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Customer Detail Modal -->
  <div id="customerBackdrop" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl w-full max-w-4xl mx-4 shadow-2xl p-6 glass-card modal-inner">
      <div class="flex justify-between items-center mb-4">
        <h3 id="custTitle" class="text-2xl font-bold text-green-800">Customer Details</h3>
        <button id="custClose" class="modal-close-btn text-gray-600 hover:text-gray-900 text-xl" aria-label="Close">âœ•</button>
      </div>

      <div id="customerDetails" class="space-y-6"></div>

      <div class="flex justify-end mt-4">
        <button id="btnReorder" class="px-5 py-2 rounded-lg bg-green-600 text-white shadow hover:bg-green-700 transition mr-3">Reorder</button>
        <button id="custClose2" class="px-5 py-2 rounded-lg bg-red-500 text-white shadow hover:bg-red-600 transition">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 right-6 bg-gray-900 text-white px-4 py-2 rounded shadow hidden"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB1wbJonjyJQDrPJWbMCVBtRolJH4HDskU",
      authDomain: "shreejee-ayucare.firebaseapp.com",
      databaseURL: "https://shreejee-ayucare-default-rtdb.firebaseio.com",
      projectId: "shreejee-ayucare",
      storageBucket: "shreejee-ayucare.firebasestorage.app",
      messagingSenderId: "247248655859",
      appId: "1:247248655859:web:b09bfc30ff6953aad42e86"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    window.logout = function() {
      localStorage.removeItem('currentTellicaller');
      window.location.href = 'index.html';
    };

    const currentUser = JSON.parse(localStorage.getItem("currentTellicaller") || "{}");
    document.getElementById("welcomeMsg").textContent = "Welcome " + (currentUser.name || "");
    if (!currentUser.name) window.location.href = "index.html";

    const ordersRef = db.ref('oms_orders');
    const customersRef = db.ref('oms_customers');
    const scheduleRef = db.ref('oms_schedule');

    let ordersSnapshot = {};
    let customersSnapshot = {};
    let scheduleSnapshot = {};
    let currentViewedOrder = null;

    const ordersContainer = document.getElementById('ordersContainer');
    const emptyMessage = document.getElementById('emptyMessage');
    const searchInput = document.getElementById('searchInput');
    const searchType = document.getElementById('searchType');
    const btnAddOrder = document.getElementById('btnAddOrder');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalClose = document.getElementById('modalClose');
    const orderForm = document.getElementById('orderForm');
    const btnCancel = document.getElementById('btnCancel');
    const toast = document.getElementById('toast');

    const customerBackdrop = document.getElementById('customerBackdrop');
    const customerDetails = document.getElementById('customerDetails');
    const custClose = document.getElementById('custClose');
    const custClose2 = document.getElementById('custClose2');

    const filterStatus = document.getElementById('filterStatus');
    const filterFrom = document.getElementById('filterFrom');
    const filterTo = document.getElementById('filterTo');

    // Form fields
    const fFirst = document.getElementById('firstName');
    const fLast = document.getElementById('lastName');
    const fPhone = document.getElementById('phone');
    const fTellicaller = document.getElementById('tellicaller');
    const fAddress = document.getElementById('address');
    const fCity = document.getElementById('city');
    const fState = document.getElementById('state');
    const fPincode = document.getElementById('pincode');
    const fAmount = document.getElementById('amount');
    const fStatus = document.getElementById('statusSelect');
    const fScheduledDate = document.getElementById('scheduledDate');
    const fProduct = document.getElementById('productSelect');
    const fPerPrice = document.getElementById('perPrice');
    const fQuantity = document.getElementById('quantity');

    function updateAmountFromInputs() {
      const per = parseFloat(fPerPrice.value) || 0;
      const qty = parseInt(fQuantity.value) || 1;
      fAmount.value = (per * qty).toFixed(2);
    }
    fPerPrice.addEventListener('input', updateAmountFromInputs);
    fQuantity.addEventListener('input', updateAmountFromInputs);

    function showToast(msg, t=3000) {
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), t);
    }

    function humanDate(ts) { return new Date(ts).toLocaleString(); }
    function generateOrderId() { return 'ord_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

    function updateOodBadge() {
      const badge = document.getElementById('oodBadge');
      if (!badge) return;
      const count = Object.values(ordersSnapshot||{}).filter(o => 
        o && o.oodStatus === 'today' && (!o.oodRemark || !['Agree','Not Picked','Refused'].includes(o.oodRemark))
      ).length;
      badge.textContent = count;
    }

    // Pincode auto-fill
    if (fPincode) {
      fPincode.addEventListener('input', () => {
        const pin = fPincode.value.trim();
        if (pin.length === 6) {
          fetch(`https://api.postalpincode.in/pincode/${pin}`)
            .then(res => res.json())
            .then(data => {
              if (data[0]?.Status === 'Success') {
                const po = data[0].PostOffice?.[0];
                if (po) {
                  fCity.value = po.District || '';
                  fState.value = po.State || '';
                }
              }
            })
            .catch(err => console.error('Pincode fetch error', err));
        }
      });
    }

    // FIXED renderOrders - Phone search now works reliably
    function renderOrders() {
      let list = Object.values(ordersSnapshot || {});

      // FIRST: Only show orders belonging to the current tellicaller
      list = list.filter(o => o.tellicaller === currentUser.name);

      const query = searchInput.value.trim();
      const type = searchType.value;

      if (query) {
        if (type === 'phone') {
          // Robust phone search: remove non-digits and allow partial match
          const cleanQuery = query.replace(/\D/g, '');
          if (cleanQuery) {
            list = list.filter(o => {
              const cleanPhone = (o.phone || '').replace(/\D/g, '');
              return cleanPhone.includes(cleanQuery);
            });
          }
        } else if (type === 'name') {
          const qLower = query.toLowerCase();
          list = list.filter(o => {
            const fullName = ((o.firstName || '') + ' ' + (o.lastName || '')).toLowerCase();
            return fullName.includes(qLower);
          });
        } else if (type === 'orderId') {
          const qLower = query.toLowerCase();
          list = list.filter(o => {
            return (o.orderId || '').toLowerCase().includes(qLower) ||
                   (o.externalOrderId || '').toLowerCase().includes(qLower);
          });
        }
      }

      // Status filter
      if (filterStatus.value === 'delivered') {
        list = list.filter(o => o.status === 'closed' && o.closedType === 'Delivered');
      } else if (filterStatus.value === 'rto') {
        list = list.filter(o => o.status === 'closed' && o.closedType === 'RTO');
      } else if (filterStatus.value === 'cancelled') {
        list = list.filter(o => o.status === 'cancelled' || (o.status === 'closed' && o.closedType === 'Cancelled'));
      }

      // Date range filter
      const fromVal = filterFrom.value ? new Date(filterFrom.value).setHours(0, 0, 0, 0) : null;
      const toVal = filterTo.value ? new Date(filterTo.value).setHours(23, 59, 59, 999) : null;
      if (fromVal || toVal) {
        list = list.filter(o => (!fromVal || o.timestamp >= fromVal) && (!toVal || o.timestamp <= toVal));
      }

      if (!list.length) {
        ordersContainer.innerHTML = '';
        emptyMessage.classList.remove('hidden');
        return;
      }
      emptyMessage.classList.add('hidden');

      // Group by date
      const groups = {};
      list.forEach(o => {
        const d = new Date(o.timestamp || Date.now());
        const key = d.toLocaleDateString();
        if (!groups[key]) groups[key] = [];
        groups[key].push(o);
      });

      ordersContainer.innerHTML = '';

      function createSection(title, arr) {
        if (!arr.length) return;
        const sec = document.createElement('div');
        sec.className = 'glass-card rounded-xl p-4';
        const head = document.createElement('h3');
        head.className = 'font-semibold text-lg mb-3 text-gray-800';
        head.textContent = title;
        sec.appendChild(head);

        arr.sort((a, b) => b.timestamp - a.timestamp).forEach(order => {
          const product = order.product || 'Karela Jamun Powder';
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between p-3 rounded-md border mb-2 shadow-sm hover:shadow-lg transition';
          if (order.status === 'cancelled' || order.closedType === 'Cancelled') {
            row.classList.add('order-cancelled');
          } else if (product === 'Men Wellness') {
            row.classList.add('product-men');
          } else {
            row.classList.add('product-karela');
          }

          const left = document.createElement('div');
          left.className = 'flex items-center gap-3';

          const pill = document.createElement('div');
          pill.className = 'product-pill';
          pill.innerHTML = (product === 'Men Wellness' ?
            `<img src='product2.png' alt='Men' class='w-8 h-8 rounded-sm inline-block mr-2'/> <span>Men Wellness</span>` :
            `<img src='product1.png' alt='Karela' class='w-8 h-8 rounded-sm inline-block mr-2'/> <span>Karela Jamun Powder</span>`
          );
          left.appendChild(pill);

          const meta = document.createElement('div');
          meta.style.minWidth = '220px';
          const nameDiv = document.createElement('div');
          nameDiv.className = 'font-medium text-blue-700 hover:underline cursor-pointer';
          nameDiv.textContent = (order.firstName || '') + ' ' + (order.lastName || '');
          nameDiv.addEventListener('click', (ev) => { ev.stopPropagation(); openCustomerModal(order.phone, order.orderId); });

          const phoneDiv = document.createElement('div');
          phoneDiv.className = 'text-xs text-gray-500';
          phoneDiv.textContent = order.phone + ' â€¢ ' + humanDate(order.timestamp || Date.now());
          meta.appendChild(nameDiv);
          meta.appendChild(phoneDiv);
          left.appendChild(meta);

          const middle = document.createElement('div');
          middle.className = 'flex flex-col text-sm w-40';
          middle.innerHTML = `
            <span class="font-semibold">â‚¹ ${Number(order.amount || 0).toFixed(2)}</span>
            <span class="text-xs text-gray-600">By: ${order.tellicaller || '-'}</span>
            <span class="text-xs text-gray-700">Product: ${product}</span>
          `;
          if (order.status === 'closed' || order.status === 'cancelled') {
            middle.innerHTML += `<span class="text-xs text-gray-700">Status: ${order.status === 'cancelled' ? 'Cancelled' : (order.closedType || '-')}</span>`;
          }

          const right = document.createElement('div');
          right.className = 'flex gap-2 items-center';
          right.innerHTML = `
            <div class="text-xs text-gray-600">${order.externalOrderId || 'Not Defined'}</div>
            <button class="px-2 py-1 rounded bg-blue-600 text-white text-xs">View</button>
          `;
          right.querySelector('button').addEventListener('click', (ev) => {
            ev.stopPropagation();
            openCustomerModal(order.phone, order.orderId);
          });

          row.appendChild(left);
          row.appendChild(middle);
          row.appendChild(right);
          sec.appendChild(row);
        });

        ordersContainer.appendChild(sec);
      }

      Object.keys(groups).sort((a, b) => new Date(b) - new Date(a)).forEach(dateStr => {
        createSection(dateStr, groups[dateStr]);
      });
    }

    // Firebase listeners
    ordersRef.on('value', snap => {
      ordersSnapshot = snap.val() || {};
      Object.keys(ordersSnapshot).forEach(k => {
        const o = ordersSnapshot[k];
        if (!('quantity' in o)) o.quantity = 1;
        if (!('perPrice' in o)) o.perPrice = o.amount && o.quantity ? parseFloat((o.amount / o.quantity).toFixed(2)) : 0;
        o.amount = parseFloat(((o.perPrice || 0) * (o.quantity || 1)).toFixed(2));
        if (!('product' in o)) o.product = 'Karela Jamun Powder';
        if (!('cancelled' in o)) o.cancelled = false;
        if (o.closedType === 'Cancelled') {
          o.status = 'cancelled';
          o.cancelled = true;
        }
        ordersSnapshot[k] = o;
      });
      renderOrders();
      updateOodBadge();
    });

    customersRef.on('value', snap => { customersSnapshot = snap.val() || {}; });
    scheduleRef.on('value', snap => { scheduleSnapshot = snap.val() || {}; });

    async function processDueSchedulesFor(dateKey) {
      const snap = await scheduleRef.child(dateKey).once('value');
      let data = snap.val() || {};
      data = Object.fromEntries(Object.entries(data).filter(([_, o]) => o.createdBy === currentUser.name));
      const keys = Object.keys(data);
      if (!keys.length) return;

      for (const orderId of keys) {
        const scheduled = data[orderId];
        if (ordersSnapshot[scheduled.orderId]) {
          await scheduleRef.child(dateKey).child(orderId).remove();
          continue;
        }
        const payload = { ...scheduled, timestamp: Date.now(), status: scheduled.status || 'open' };
        await ordersRef.child(scheduled.orderId).set(payload);
        await scheduleRef.child(dateKey).child(orderId).remove();
      }
      showToast(`${keys.length} scheduled order(s) moved to live`, 4000);
    }
    const todayKey = new Date().toISOString().split('T')[0];
    processDueSchedulesFor(todayKey);

    // Add Order modal
    btnAddOrder.addEventListener('click', () => {
      orderForm.reset();
      fTellicaller.value = currentUser.name;
      document.getElementById('modalTitle').textContent = 'Add Order';
      fStatus.value = 'open';
      fScheduledDate.value = new Date().toISOString().split('T')[0];
      fProduct.value = 'Karela Jamun Powder';
      updateAmountFromInputs();
      modalBackdrop.style.display = 'flex';
      modalBackdrop.classList.remove('hidden');
    });

    modalClose.addEventListener('click', () => { modalBackdrop.style.display = 'none'; modalBackdrop.classList.add('hidden'); });
    btnCancel.addEventListener('click', () => { modalBackdrop.style.display = 'none'; modalBackdrop.classList.add('hidden'); });

    orderForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        orderId: generateOrderId(),
        firstName: fFirst.value.trim(),
        lastName: fLast.value.trim(),
        phone: fPhone.value.trim(),
        tellicaller: fTellicaller.value.trim() || currentUser.name,
        address: fAddress.value.trim(),
        city: fCity.value.trim(),
        state: fState.value.trim(),
        pincode: fPincode.value.trim(),
        perPrice: parseFloat(fPerPrice.value) || 0,
        quantity: parseInt(fQuantity.value) || 1,
        amount: parseFloat(fAmount.value) || 0,
        product: fProduct.value || 'Karela Jamun Powder',
        status: fStatus.value || 'open',
        timestamp: Date.now(),
        externalOrderId: '',
        cancelled: false
      };

      if (!payload.firstName || !payload.phone) {
        alert('First name and phone required.');
        return;
      }

      await ordersRef.child(payload.orderId).set(payload);

      const phoneKey = payload.phone;
      const existing = customersSnapshot[phoneKey];
      if (existing) {
        const ordersMap = existing.orders || {};
        ordersMap[payload.orderId] = true;
        await customersRef.child(phoneKey).update({ orders: ordersMap, tellicallerLast: payload.tellicaller });
      } else {
        const newCust = {
          firstName: payload.firstName,
          lastName: payload.lastName,
          phone: payload.phone,
          address: payload.address,
          city: payload.city,
          state: payload.state,
          pincode: payload.pincode,
          tellicallerLast: payload.tellicaller,
          createdAt: Date.now(),
          orders: { [payload.orderId]: true }
        };
        await customersRef.child(phoneKey).set(newCust);
      }

      modalBackdrop.style.display = 'none';
      modalBackdrop.classList.add('hidden');
      showToast('Order saved');
    });

    // Customer modal
    function openCustomerModal(phone, orderId) {
      const o = ordersSnapshot[orderId];
      if (!o) {
        alert('Order data not found');
        return;
      }
      currentViewedOrder = o;

      let html = `
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div><strong>Name</strong><div>${o.firstName} ${o.lastName||''}</div></div>
          <div><strong>Phone</strong><div>${o.phone}</div></div>
          <div><strong>Address</strong><div>${o.address||'-'}</div></div>
          <div><strong>City/State/Pin</strong><div>${o.city||'-'} / ${o.state||'-'} / ${o.pincode||'-'}</div></div>
          <div><strong>Product</strong><div>${o.product}</div></div>
          <div><strong>Amount</strong><div>â‚¹ ${Number(o.amount||0).toFixed(2)}</div></div>
        </div>
        <h4 class="font-bold text-lg mb-3">Order History</h4>
      `;

      const histList = document.createElement('div');
      histList.className = 'space-y-3';

      const histOrders = Object.values(ordersSnapshot).filter(x => x.phone === phone);
      histOrders.sort((a,b)=>b.timestamp-a.timestamp);

      if (!histOrders.length) {
        histList.innerHTML = '<p class="text-gray-500">No orders found for this customer.</p>';
      } else {
        histOrders.forEach(h => {
          const prod = h.product || 'Karela Jamun Powder';
          const wrap = document.createElement('div');
          wrap.className = 'p-3 rounded-md border flex items-start gap-4 relative';
          if (h.status === 'closed' && h.closedType === 'RTO') wrap.classList.add('highlight-rto');
          if (h.status === 'closed' && h.closedType === 'Delivered') wrap.classList.add('highlight-delivered');
          if (h.status === 'cancelled' || h.closedType === 'Cancelled') wrap.classList.add('order-cancelled');

          const iconDiv = document.createElement('div');
          iconDiv.className = 'status-icon';
          if (h.status === 'closed' && h.closedType === 'Delivered') {
            iconDiv.classList.add('status-icon-delivered');
            iconDiv.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>';
          } else if (h.status === 'closed' && h.closedType === 'RTO') {
            iconDiv.classList.add('status-icon-rto');
            iconDiv.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg>';
          } else if (h.status === 'dispatched') {
            iconDiv.classList.add('status-icon-intransit');
            iconDiv.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
          } else {
            iconDiv.classList.add('status-icon-undispatched');
          }
          wrap.appendChild(iconDiv);

          const content = document.createElement('div');
          content.className = 'flex-1';
          content.innerHTML = `
            <div class="font-medium">${h.firstName} ${h.lastName||''} â€¢ ${h.phone}</div>
            <div class="text-sm text-gray-600">${prod} â€¢ â‚¹ ${Number(h.amount||0).toFixed(2)}</div>
            <div class="text-xs text-gray-500">${humanDate(h.timestamp)}</div>
            ${h.status === 'cancelled' ? `<div class="text-sm text-red-600 mt-1"><b>Cancelled:</b> ${h.cancelledReason || '-'}</div>` : ''}
            ${h.closedType === 'RTO' ? `<div class="text-sm text-red-600 mt-1"><b>RTO Remark:</b> ${h.remark || '-'}</div>` : ''}
          `;
          wrap.appendChild(content);

          if (h.status !== 'closed' && h.status !== 'cancelled' && h.tellicaller === currentUser.name) {
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel Order';
            cancelBtn.className = 'px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700';
            cancelBtn.onclick = (e) => {
              e.stopPropagation();
              const reason = prompt('Enter cancellation reason:');
              if (reason === null) return;
              if (reason.trim() === '') {
                alert('Reason is required.');
                return;
              }

              db.ref(`oms_orders/${h.orderId}`).update({
                status: 'cancelled',
                cancelled: true,
                closedType: 'Cancelled',
                cancelledReason: reason.trim(),
                cancelledBy: currentUser.name,
                cancelledAt: Date.now()
              }).then(() => {
                showToast('Order cancelled successfully');
              }).catch(err => {
                console.error(err);
                alert('Failed to cancel order.');
              });
            };
            wrap.appendChild(cancelBtn);
          }

          histList.appendChild(wrap);
        });
      }

      customerDetails.innerHTML = html;
      customerDetails.appendChild(histList);
      customerBackdrop.style.display = 'flex';
      customerBackdrop.classList.remove('hidden');
    }

    custClose.addEventListener('click', () => {
      customerBackdrop.style.display = 'none';
      customerBackdrop.classList.add('hidden');
    });
    custClose2.addEventListener('click', () => {
      customerBackdrop.style.display = 'none';
      customerBackdrop.classList.add('hidden');
    });

    document.getElementById('btnReorder').addEventListener('click', () => {
      if (!currentViewedOrder) {
        alert('No order selected for reorder.');
        return;
      }

      const o = currentViewedOrder;

      document.getElementById('modalTitle').textContent = 'Reorder';
      fFirst.value = o.firstName || '';
      fLast.value = o.lastName || '';
      fPhone.value = o.phone || '';
      fTellicaller.value = currentUser.name;
      fAddress.value = o.address || '';
      fCity.value = o.city || '';
      fState.value = o.state || '';
      fPincode.value = o.pincode || '';
      fPerPrice.value = o.perPrice || '';
      fQuantity.value = o.quantity || 1;
      updateAmountFromInputs();
      fProduct.value = o.product === 'Men Wellness' ? 'Men Wellness' : 'Karela Jamun Powder';
      fStatus.value = 'open';
      fScheduledDate.value = new Date().toISOString().split('T')[0];

      customerBackdrop.style.display = 'none';
      customerBackdrop.classList.add('hidden');
      modalBackdrop.style.display = 'flex';
      modalBackdrop.classList.remove('hidden');
    });

    // Re-render on any search change
    searchInput.addEventListener('input', renderOrders);
    searchType.addEventListener('change', renderOrders);
    filterStatus.addEventListener('change', renderOrders);
    filterFrom.addEventListener('change', renderOrders);
    filterTo.addEventListener('change', renderOrders);

    // Initial render
    renderOrders();
  </script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Order Management â€” ShreeJee Ayucare (Tellecaller Portal â€” Updated)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Background & glass look */
    body{
      background: linear-gradient(-45deg,#065f46,#047857,#10b981,#6ee7b7);
      background-size:400% 400%;
      animation: gradientBG 12s ease infinite;
    }
    @keyframes gradientBG {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    .glass-card { background: rgba(255,255,255,0.18); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: all .18s ease; }
    .glass-card:hover { transform: translateY(-6px) scale(1.01); box-shadow: 0 18px 40px rgba(0,0,0,0.22); }
    .order-open { box-shadow: 0 0 0 3px rgba(250,180,30,0.06); }
    .status-square { width:22px; height:22px; border-radius:4px; display:inline-block; cursor:pointer; }
    .status-square.locked { cursor: not-allowed; opacity:.55; }
    .clickable { cursor:pointer; }

    /* Product badges & card styles */
    .product-karela { background: linear-gradient(90deg,#ecfdf5,#ecfeff); border-left:4px solid #10b981; }
    .product-men { background: linear-gradient(90deg,#eef2ff,#f5f3ff); border-left:4px solid #7c3aed; }
    .order-cancelled { background:#f3f4f6; border:2px solid #dc2626; } /* Grey fill + Red border */

    .product-pill { display:inline-flex; align-items:center; gap:8px; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600; }
    .product-pill svg { width:18px; height:18px; }

    /* small responsive tweaks */
    @media (max-width:640px){
      .w-40{ width:150px !important; }
    }

    /* modal inner wrapper for relative positioning */
    .modal-inner { position: relative; }
    .modal-close-btn {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      background: rgba(255,255,255,0.95);
      border-radius: 9999px;
      padding: 6px 10px;
      font-size: 1.15rem;
      line-height: 1;
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
      border: 1px solid rgba(0,0,0,0.06);
      z-index: 60;
      cursor: pointer;
    }

  </style>
</head>
<body class="font-sans text-gray-800 min-h-screen">

  <!-- NAV -->
  <nav class="bg-green-900/95 text-white fixed top-0 left-0 right-0 z-50 shadow-md">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="logo.jpg" alt="Logo" class="h-10 w-10 rounded-full object-cover shadow-md" onerror="this.style.display='none'">
        <div>
          <div class="font-semibold text-lg">ShreeJee Ayucare</div>
          <div id="welcomeMsg" class="text-sm text-yellow-300 font-bold"></div>
          <div class="text-xs text-green-200">Tellecaller Portal</div>
        </div>
      </div>

      <div id="navControls" class="flex flex-wrap items-center gap-3">
        <input id="searchInput" type="search" placeholder="Search name or phone..." class="px-3 py-2 rounded-md border bg-white text-black w-64 shadow-sm" />

        <select id="filterStatus" class="px-2 py-2 rounded-md border bg-white text-black shadow-sm">
          <option value="all">All Status</option>
          <option value="delivered">Delivered</option>
          <option value="rto">RTO</option>
          <option value="cancelled">Cancelled</option>
        </select>

        <input id="filterFrom" type="date" class="px-2 py-2 rounded-md border bg-white text-black shadow-sm" />
        <input id="filterTo" type="date" class="px-2 py-2 rounded-md border bg-white text-black shadow-sm" />

        <button id="btnAddOrder" class="bg-yellow-400 hover:bg-yellow-500 px-4 py-2 rounded-md font-semibold shadow">+ Add Order</button>
        <button id="btnSchedule" onclick="window.location.href='schedule.html'"
       class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md shadow">Schedule</button>
        <button onclick="window.location.href='out_of_delivery.html'"
       class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md shadow flex items-center gap-2">
       Out of Delivery 
       <span id="oodBadge" class="ml-1 bg-red-500 text-white rounded-full px-2 py-0.5 text-xs">0</span>
      </button>
        <button id="btnLogout" onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-md font-semibold shadow text-white">Logout</button>
      <button onclick="window.location.href='History.html'"
       class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md shadow flex items-center gap-2">
       History
      </button>
      </div>
    </div>
  </nav>
<div id="headerSpacer" style="height:72px"></div>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto p-6">
    <div id="ordersContainer" class="space-y-6"></div>
    <p id="emptyMessage" class="text-center text-gray-200 mt-8 hidden">No orders found.</p>
  </main>

  <!-- Add Order Modal -->
  <div id="modalBackdrop" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg w-full max-w-2xl mx-4 shadow-lg p-6 modal-inner">
      <div class="flex justify-between items-center mb-4">
        <h3 id="modalTitle" class="text-lg font-semibold">Add Order</h3>
        <button id="modalClose" class="modal-close-btn text-gray-600 hover:text-gray-900" aria-label="Close add order modal">âœ•</button>
      </div>

      <form id="orderForm" class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <input id="firstName" class="border p-2 rounded" placeholder="First name" required />
          <input id="lastName" class="border p-2 rounded" placeholder="Last name" />
        </div>

        <div class="grid grid-cols-2 gap-3">
          <input id="phone" class="border p-2 rounded" placeholder="Phone (10 digits)" required />
          <input id="tellicaller" class="border p-2 rounded" placeholder="Order placed by (Tellicaller)" required />
        </div>

        <input id="address" class="border p-2 rounded" placeholder="Address" />
        <div class="grid grid-cols-3 gap-3">
          <input id="city" class="border p-2 rounded" placeholder="City" />
          <input id="state" class="border p-2 rounded" placeholder="State" />
          <input id="pincode" class="border p-2 rounded" placeholder="Pincode" maxlength="6" />
        </div>

        <div class="grid grid-cols-3 gap-3">
          <input id="perPrice" type="number" min="0" step="0.01" class="border p-2 rounded" placeholder="Per Price (Single Piece)" required />
          <input id="quantity" type="number" min="1" step="1" class="border p-2 rounded" placeholder="Quantity" value="1" required />
          <input id="amount" type="number" min="0" step="0.01" class="border p-2 rounded" placeholder="Total Amount" required readonly />
        </div>

        <div class="grid grid-cols-3 gap-3 items-center">
          <select id="statusSelect" class="border p-2 rounded">
            <option value="open">Open</option>
            <option value="dispatched">Dispatched</option>
          </select>
          <input id="scheduledDate" type="date" class="border p-2 rounded" title="Choose a date to schedule this order (defaults to today)" />
          <!-- Product selector with small inline icons -->
          <select id="productSelect" class="border p-2 rounded">
            <option value="Karela Jamun Powder">ðŸŸ¢ Karela Jamun Powder</option>
            <option value="Men Wellness">ðŸŸ£ Men Wellness</option>
          </select><img id="productSelectIcon" src="product1.png" alt="product icon" class="inline-block w-12 h-12 ml-2 align-middle"/> 
        </div>

        <div class="flex justify-end gap-3 pt-2">
          <button type="button" id="btnCancel" class="px-4 py-2 rounded border">Cancel</button>
          <button type="submit" id="btnSaveOrder" class="px-4 py-2 rounded bg-green-700 text-white">Save Order</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Customer Detail Modal (updated to include Reorder) -->
  <div id="customerBackdrop" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl w-full max-w-4xl mx-4 shadow-2xl p-6 glass-card modal-inner">
      <div class="flex justify-between items-center mb-4">
        <h3 id="custTitle" class="text-2xl font-bold text-green-800">Customer Details</h3>
        <button id="custClose" class="modal-close-btn text-gray-600 hover:text-gray-900 text-xl" aria-label="Close customer details">âœ•</button>
      </div>

      <div id="customerDetails" class="space-y-6"></div>

      <div class="flex justify-end mt-4">
        <button id="btnReorder" class="px-5 py-2 rounded-lg bg-green-600 text-white shadow hover:bg-green-700 transition mr-3">Reorder</button>
        <button id="custClose2" class="px-5 py-2 rounded-lg bg-red-500 text-white shadow hover:bg-red-600 transition">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 right-6 bg-gray-900 text-white px-4 py-2 rounded shadow hidden"></div>

  <!-- Firebase libs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
  /******** Firebase config (replace if needed) ********/
  const firebaseConfig = {
    apiKey: "AIzaSyB1wbJonjyJQDrPJWbMCVBtRolJH4HDskU",
    authDomain: "shreejee-ayucare.firebaseapp.com",
    databaseURL: "https://shreejee-ayucare-default-rtdb.firebaseio.com",
    projectId: "shreejee-ayucare",
    storageBucket: "shreejee-ayucare.firebasestorage.app",
    messagingSenderId: "247248655859",
    appId: "1:247248655859:web:b09bfc30ff6953aad42e86"
  };
  if (!firebase.apps || !firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  } else if (firebase.apps.length === 0) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.database();


  // global logout function
  window.logout = function() {
    try { localStorage.removeItem('currentTellicaller'); } catch(e) {}
    window.location.href = 'index.html';
  };

  /******** App state & elements ********/
  const currentUser = JSON.parse(localStorage.getItem("currentTellicaller") || "{}");
  // show welcome message in nav
  try{ const welcomeMsgEl = document.getElementById("welcomeMsg"); if (welcomeMsgEl) welcomeMsgEl.textContent = "Welcome " + (currentUser.name || ""); }catch(e){}
  if (!currentUser.name) { window.location.href = "index.html"; }

  const ordersRef = db.ref('oms_orders');
  const customersRef = db.ref('oms_customers');
  const scheduleRef = db.ref('oms_schedule');

  let ordersSnapshot = {};
  let customersSnapshot = {};
  let scheduleSnapshot = {};

  const ordersContainer = document.getElementById('ordersContainer');
  const emptyMessage = document.getElementById('emptyMessage');
  const searchInput = document.getElementById('searchInput');
  const btnAddOrder = document.getElementById('btnAddOrder');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalClose = document.getElementById('modalClose');
  const orderForm = document.getElementById('orderForm');
  const btnCancel = document.getElementById('btnCancel');
  const toast = document.getElementById('toast');

  const customerBackdrop = document.getElementById('customerBackdrop');
  const custTitle = document.getElementById('custTitle');
  const customerDetails = document.getElementById('customerDetails');
  const custClose = document.getElementById('custClose');
  const custClose2 = document.getElementById('custClose2');
  const btnReorder = document.getElementById('btnReorder');

  const filterStatus = document.getElementById('filterStatus');
  const filterFrom = document.getElementById('filterFrom');
  const filterTo = document.getElementById('filterTo');

  // form fields
  const fFirst = document.getElementById('firstName');
  const fLast = document.getElementById('lastName');
  const fPhone = document.getElementById('phone');
  const fTellicaller = document.getElementById('tellicaller');
  const fAddress = document.getElementById('address');
  const fCity = document.getElementById('city');
  const fState = document.getElementById('state');
  const fPincode = document.getElementById('pincode');
  const fAmount = document.getElementById('amount');
  const fStatus = document.getElementById('statusSelect');
  const fScheduledDate = document.getElementById('scheduledDate');
  const fProduct = document.getElementById('productSelect');

  const fPerPrice = document.getElementById('perPrice');
  const fQuantity = document.getElementById('quantity');

  function updateAmountFromInputs() {
    const per = parseFloat(fPerPrice.value) || 0;
    const qty = parseInt(fQuantity.value) || 1;
    const total = per * qty;
    fAmount.value = total.toFixed(2);
  }
  if (fPerPrice) fPerPrice.addEventListener('input', updateAmountFromInputs);
  if (fQuantity) fQuantity.addEventListener('input', updateAmountFromInputs);
  try { updateAmountFromInputs(); } catch(e) {}

  function showToast(msg, t=3000){
    toast.textContent = msg;
    toast.classList.remove('hidden');
    setTimeout(()=> toast.classList.add('hidden'), t);
  }
  function humanDate(ts){ return new Date(ts).toLocaleString(); }
  function generateOrderId(){ return 'ord_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

  function updateOodBadge(){
    const badge = document.getElementById('oodBadge');
    if (!badge) return;
    const count = Object.values(ordersSnapshot||{}).filter(o =>
      o && o.oodStatus === 'today' && (!o.oodRemark || !['Agree','Not Picked','Refused'].includes(o.oodRemark))
    ).length;
    badge.textContent = count;
  }

  /******** Render Orders (grouped) with product awareness ********/
  function renderOrders(filterText=''){
    let list = Object.values(ordersSnapshot || {});
    const q = filterText.trim().toLowerCase();
    if (q) {
      list = list.filter(o=>{
        const nm = ((o.firstName||'') + ' ' + (o.lastName||'')).toLowerCase();
        return nm.includes(q) || (o.phone||'').includes(q);
      });
    }

    // Tellecaller portal shows only currentUser's orders
    list = list.filter(o => o.tellicaller === currentUser.name);

    // status filter
    if (filterStatus.value === 'delivered') {
      list = list.filter(o => o.status === 'closed' && o.closedType === 'Delivered');
    } else if (filterStatus.value === 'rto') {
      list = list.filter(o => o.status === 'closed' && o.closedType === 'RTO');
    } else if (filterStatus.value === 'cancelled') {
      list = list.filter(o => o.status === 'cancelled' || (o.status==='closed' && o.closedType==='Cancelled'));
    }

    // date range
    const fromVal = filterFrom.value ? new Date(filterFrom.value).setHours(0,0,0,0) : null;
    const toVal = filterTo.value ? new Date(filterTo.value).setHours(23,59,59,999) : null;
    if (fromVal || toVal) {
      list = list.filter(o => (!fromVal || o.timestamp >= fromVal) && (!toVal || o.timestamp <= toVal));
    }

    if (!list.length) {
      ordersContainer.innerHTML = '';
      emptyMessage.classList.remove('hidden');
      return;
    }
    emptyMessage.classList.add('hidden');

    // group orders by calendar date
    const groups = {};
    list.forEach(o => {
      const d = new Date(o.timestamp || Date.now());
      const key = d.toLocaleDateString();
      if (!groups[key]) groups[key] = [];
      groups[key].push(o);
    });

    ordersContainer.innerHTML = '';

    function createSection(title, arr) {
      if (!arr.length) return;
      const sec = document.createElement('div');
      sec.className = 'glass-card rounded-xl p-4';
      const head = document.createElement('h3');
      head.className = 'font-semibold text-lg mb-3 text-gray-800';
      head.textContent = title;
      sec.appendChild(head);

      arr.sort((a,b)=>b.timestamp - a.timestamp).forEach(order => {
        // normalize product for display (backcompat)
        const product = order.product || 'Karela Jamun Powder';
        const row = document.createElement('div');
        // base classes + product-specific
        row.className = 'flex items-center justify-between p-3 rounded-md border mb-2 shadow-sm hover:shadow-lg transition';
        if (order.status === 'cancelled' || order.closedType === 'Cancelled') {
          row.classList.add('order-cancelled');
        } else if (product === 'Men Wellness') {
          row.classList.add('product-men');
        } else {
          row.classList.add('product-karela');
        }

        // LEFT: product pill + name+phone+time
        const left = document.createElement('div');
        left.className = 'flex items-center gap-3';

        // product pill with inline svg icons (Ayurvedic bottle & shield)
        const pill = document.createElement('div');
        pill.className = 'product-pill';
        pill.innerHTML = (product === 'Men Wellness' ? 
          `<img src='product2.png' alt='Men' class='w-8 h- rounded-sm inline-block mr-2 align-middle'/> <span>Men Wellness</span>`
          :
          `<img src='product1.png' alt='Karela' class='w-8 h-8 rounded-sm inline-block mr-2 align-middle'/> <span>Karela Jamun Powder</span>`
        );
        left.appendChild(pill);

        const meta = document.createElement('div');
        meta.style.minWidth = '220px';
        const nameDiv = document.createElement('div');
        nameDiv.className = 'font-medium text-blue-700 hover:underline cursor-pointer';
        nameDiv.textContent = (order.firstName||'') + ' ' + (order.lastName||'');
        nameDiv.addEventListener('click', (ev)=>{ ev.stopPropagation(); openCustomerModal(order.phone, order.orderId); });

        const phoneDiv = document.createElement('div');
        phoneDiv.className = 'text-xs text-gray-500';
        phoneDiv.textContent = order.phone + ' â€¢ ' + humanDate(order.timestamp || Date.now());

        meta.appendChild(nameDiv);
        meta.appendChild(phoneDiv);
        left.appendChild(meta);

        // MIDDLE: aligned vertical block
        const middle = document.createElement('div');
        middle.className = 'flex flex-col text-sm w-40';
        const amt = document.createElement('span'); amt.className = 'font-semibold'; amt.textContent = 'â‚¹ ' + (order.amount != null ? Number(order.amount).toFixed(2) : '0.00');
        const tel = document.createElement('span'); tel.className = 'text-xs text-gray-600'; tel.textContent = 'By: ' + (order.tellicaller || '-');
        middle.appendChild(amt);
        middle.appendChild(tel);
        // product name visible
        const prodLine = document.createElement('span'); prodLine.className = 'text-xs text-gray-700'; prodLine.innerHTML = "Product: " + product;
        middle.appendChild(prodLine);
        if (order.status === 'closed' || order.status === 'cancelled') {
          const st = document.createElement('span'); st.className = 'text-xs text-gray-700'; 
          st.textContent = 'Status: ' + (order.status === 'cancelled' ? 'Cancelled' : (order.closedType || '-'));
          middle.appendChild(st);
        }

        // RIGHT: orderId + view
        const right = document.createElement('div');
        right.className = 'flex gap-2 items-center';
        const orderIdEl = document.createElement('div');
        orderIdEl.className = 'text-xs text-gray-600';
        orderIdEl.textContent = (order.externalOrderId && order.externalOrderId !== '') ? order.externalOrderId : 'Not Defined';
        right.appendChild(orderIdEl);

        const viewBtn = document.createElement('button');
        viewBtn.className = 'px-2 py-1 rounded bg-blue-600 text-white text-xs';
        viewBtn.textContent = 'View';
        viewBtn.addEventListener('click', (ev) => { ev.stopPropagation(); openCustomerModal(order.phone, order.orderId); });
        right.appendChild(viewBtn);

        row.appendChild(left);
        row.appendChild(middle);
        row.appendChild(right);
        sec.appendChild(row);
      });

      ordersContainer.appendChild(sec);
    }

    Object.keys(groups).sort((a,b)=> new Date(b) - new Date(a)).forEach(dateStr => {
      createSection(dateStr, groups[dateStr]);
    });
  }

  /******** Firebase listeners & backward compatibility ********/
  ordersRef.on('value', snap => {
    ordersSnapshot = snap.val() || {};
    // normalize older orders that may be missing quantity/perPrice/product/cancelled (backwards-compat)
    Object.keys(ordersSnapshot).forEach(k => {
      const o = ordersSnapshot[k] || {};
      if (!('quantity' in o)) o.quantity = 1;
      if (!('perPrice' in o)) {
        const q = o.quantity || 1;
        o.perPrice = (o.amount && q ? parseFloat((o.amount / q).toFixed(2)) : 0);
      }
      // ensure amount is consistent with perPrice * quantity
      o.amount = parseFloat(((o.perPrice || 0) * (o.quantity || 1)).toFixed(2));
      // default product for older orders
      if (!('product' in o) || !o.product) o.product = 'Karela Jamun Powder';
      // ensure cancelled flag exists
      if (!('cancelled' in o)) o.cancelled = false;
      // handle legacy closedType 'Cancelled'
      if (o.closedType === 'Cancelled') {
        o.status = 'cancelled';
        o.cancelled = true;
      }
      ordersSnapshot[k] = o;
    });

    renderOrders(searchInput.value);
    updateOodBadge();
  });

  customersRef.on('value', snap => {
    customersSnapshot = snap.val() || {};
  });
  scheduleRef.on('value', snap => {
    scheduleSnapshot = snap.val() || {};
  });

  /******** Scheduler (unchanged) ********/
  function todayKeyString(d = new Date()) { return d.toISOString().split('T')[0]; }
  async function processDueSchedulesFor(dateKey) {
    try {
      const snap = await scheduleRef.child(dateKey).once('value');
      let data = snap.val() || {};
      data = Object.fromEntries(Object.entries(data).filter(([_, o]) => (o.createdBy === currentUser.name)));
      const keys = Object.keys(data);
      if (!keys.length) return;
      for (const orderId of keys) {
        const scheduled = data[orderId];
        if (ordersSnapshot && ordersSnapshot[scheduled.orderId]) {
          await scheduleRef.child(dateKey).child(orderId).remove();
          continue;
        }
        const orderPayload = Object.assign({}, scheduled);
        if (!('quantity' in orderPayload)) orderPayload.quantity = 1;
        if (!('perPrice' in orderPayload)) orderPayload.perPrice = orderPayload.amount ? parseFloat((orderPayload.amount / orderPayload.quantity).toFixed(2)) : 0;
        // ensure product defaults
        if (!('product' in orderPayload) || !orderPayload.product) orderPayload.product = 'Karela Jamun Powder';
        orderPayload.timestamp = Date.now();
        orderPayload.status = scheduled.status || 'open';
        orderPayload.externalOrderId = scheduled.externalOrderId || '';
        await ordersRef.child(scheduled.orderId).set(orderPayload);

        // update/create customer node
        const phoneKey = scheduled.phone;
        const existing = customersSnapshot[phoneKey] || null;
        if (existing) {
          const ordersMap = existing.orders || {};
          ordersMap[scheduled.orderId] = true;
          const scheduledMap = existing.scheduledOrders || {};
          if (scheduledMap[scheduled.orderId]) delete scheduledMap[scheduled.orderId];
          const updateObj = { orders: ordersMap, scheduledOrders: scheduledMap, tellicallerLast: scheduled.tellicaller };
          await customersRef.child(phoneKey).update(updateObj);
        } else {
          const newCust = {
            firstName: scheduled.firstName || '',
            lastName: scheduled.lastName || '',
            phone: scheduled.phone || '',
            address: scheduled.address || '',
            city: scheduled.city || '',
            state: scheduled.state || '',
            pincode: scheduled.pincode || '',
            tellicallerLast: scheduled.tellicaller || '',
            createdAt: Date.now(),
            orders: {}
          };
          newCust.orders[scheduled.orderId] = true;
          await customersRef.child(phoneKey).set(newCust);
        }
        await scheduleRef.child(dateKey).child(orderId).remove();
      }
      showToast(`${keys.length} scheduled order(s) moved to live orders for ${dateKey}`, 4000);
    } catch (err) {
      console.error('Error processing scheduled orders for', dateKey, err);
    }
  }
  const todayKey = todayKeyString();
  processDueSchedulesFor(todayKey).catch(()=>{});
  scheduleRef.child(todayKey).on('value', snap=>{ if (snap.exists()) processDueSchedulesFor(todayKey).catch(()=>{}); });

  /******** Add Order modal handling (now includes product) ********/
  btnAddOrder.addEventListener('click', ()=>{
    // sync small product icon beside select
    try {
      const psi = document.getElementById('productSelectIcon');
      const psel = document.getElementById('productSelect');
      function updateProductIcon(){ if(!psi || !psel) return; psi.src = (psel.value && psel.value.toLowerCase().includes('men')) ? 'product2.png' : 'product1.png'; }
      updateProductIcon();
      if (psel) psel.addEventListener('change', updateProductIcon);
    } catch(e){}

    orderForm.reset();
    fTellicaller.value = currentUser.name || '';
    document.getElementById('modalTitle').textContent = 'Add Order';
    fStatus.value = 'open';
    try {
      const today = new Date().toISOString().split('T')[0];
      fScheduledDate.value = today;
    } catch(e) { fScheduledDate.value = ''; }
    // default product selection
    try { document.getElementById('productSelect').value = 'Karela Jamun Powder'; } catch(e){}
    modalBackdrop.style.display = 'flex';
    modalBackdrop.classList.remove('hidden');
  });
  modalClose.addEventListener('click', ()=>{ modalBackdrop.style.display = 'none'; modalBackdrop.classList.add('hidden'); });
  btnCancel.addEventListener('click', ()=>{ modalBackdrop.style.display = 'none'; modalBackdrop.classList.add('hidden'); });

  orderForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const firstName = fFirst.value.trim();
    const lastName = fLast.value.trim();
    const phone = fPhone.value.trim();
    const tellicaller = fTellicaller.value.trim() || currentUser.name;
    const address = fAddress.value.trim();
    const city = fCity.value.trim();
    const state = fState.value.trim();
    const pincode = fPincode.value.trim();
    const perPrice = parseFloat(fPerPrice.value) || 0;
    const quantity = parseInt(fQuantity.value) || 1;
    const amount = parseFloat((perPrice * quantity).toFixed(2)) || parseFloat(fAmount.value) || 0;
    const status = fStatus.value || 'open';
    const scheduledDate = fScheduledDate.value || '';
    const product = fProduct.value || 'Karela Jamun Powder';

    if (!firstName || !phone) {
      alert('Please provide first name and phone.');
      return;
    }

    // create a new order object and push
    const orderId = generateOrderId();
    const payload = {
      orderId,
      firstName, lastName, phone, tellicaller,
      address, city, state, pincode,
      perPrice, quantity, amount,
      product, status,
      timestamp: Date.now(),
      externalOrderId: '',
      cancelled: false
    };

    try {
      await ordersRef.child(orderId).set(payload);

      // Update / create customer
      const phoneKey = phone;
      const existing = customersSnapshot[phoneKey] || null;
      if (existing) {
        const ordersMap = existing.orders || {};
        ordersMap[orderId] = true;
        await customersRef.child(phoneKey).update({ orders: ordersMap, tellicallerLast: tellicaller });
      } else {
        const newCust = {
          firstName, lastName, phone, address, city, state, pincode,
          tellicallerLast: tellicaller, createdAt: Date.now(),
          orders: {}
        };
        newCust.orders[orderId] = true;
        await customersRef.child(phoneKey).set(newCust);
      }

      modalBackdrop.style.display = 'none';
      modalBackdrop.classList.add('hidden');
      showToast('Order saved');
    } catch (err) {
      console.error('Error saving order', err);
      alert('Failed to save order. See console.');
    }
  });

  /******** Customer modal + Reorder support ********/
  // openCustomerModal: shows customer details and enables Reorder
  let currentViewedOrderId = null;
  function openCustomerModal(phone, orderId) {
    currentViewedOrderId = orderId || null;
    const order = (orderId && ordersSnapshot && ordersSnapshot[orderId]) ? ordersSnapshot[orderId] : null;
    const cust = (phone && customersSnapshot && customersSnapshot[phone]) ? customersSnapshot[phone] : null;

    // Build details HTML (keeps previous look & feel)
    let html = '';
    if (order) {
      html += `<div class="grid grid-cols-2 gap-4">`;
      html += `<div><strong>Name</strong><div>${(order.firstName||'') + ' ' + (order.lastName||'')}</div></div>`;
      html += `<div><strong>Phone</strong><div>${order.phone}</div></div>`;
      html += `<div><strong>Address</strong><div>${order.address || '-'}</div></div>`;
      html += `<div><strong>City/State</strong><div>${(order.city||'-')} / ${(order.state||'-')}</div></div>`;
      html += `<div><strong>Product</strong><div>${order.product || '-'}</div></div>`;
      html += `<div><strong>Amount</strong><div>â‚¹ ${Number(order.amount||0).toFixed(2)}</div></div>`;
      html += `</div>`;
      html += `<div class="mt-4"><strong>Order ID</strong><div>${order.orderId || '-'}</div></div>`;
      html += `<div class="mt-2"><strong>Status</strong><div>${order.status || '-'}</div></div>`;
    } else if (cust) {
      html += `<div class="grid grid-cols-2 gap-4">`;
      html += `<div><strong>Name</strong><div>${(cust.firstName||'') + ' ' + (cust.lastName||'')}</div></div>`;
      html += `<div><strong>Phone</strong><div>${cust.phone}</div></div>`;
      html += `<div><strong>Address</strong><div>${cust.address || '-'}</div></div>`;
      html += `<div><strong>City/State</strong><div>${(cust.city||'-')} / ${(cust.state||'-')}</div></div>`;
      html += `</div>`;
    } else {
      html = '<div>No details available.</div>';
    }

    customerDetails.innerHTML = html;
    customerBackdrop.style.display = 'flex';
    customerBackdrop.classList.remove('hidden');
  }

  // Close customer modal
  [custClose, custClose2].forEach(el=>{
    el && el.addEventListener('click', ()=>{
      customerBackdrop.style.display = 'none';
      customerBackdrop.classList.add('hidden');
      currentViewedOrderId = null;
    });
  });

  // Reorder button behavior: prefill Add Order form and open modal
  btnReorder.addEventListener('click', (ev) => {
    ev.preventDefault();
    // if no viewed order, try to use customer phone from displayed details (best-effort)
    if (!currentViewedOrderId) {
      alert('No order selected to reorder.');
      return;
    }
    const srcOrder = ordersSnapshot[currentViewedOrderId];
    if (!srcOrder) {
      alert('Original order not found.');
      return;
    }

    // pre-fill order form with data from srcOrder
    try {
      document.getElementById('modalTitle').textContent = 'Reorder';
      fFirst.value = srcOrder.firstName || '';
      fLast.value = srcOrder.lastName || '';
      fPhone.value = srcOrder.phone || '';
      fTellicaller.value = currentUser.name || ''; // ensure tellicaller is current logged-in tellecaller
      fAddress.value = srcOrder.address || '';
      fCity.value = srcOrder.city || '';
      fState.value = srcOrder.state || '';
      fPincode.value = srcOrder.pincode || '';
      fPerPrice.value = (srcOrder.perPrice != null) ? srcOrder.perPrice : (srcOrder.amount && srcOrder.quantity ? (srcOrder.amount / srcOrder.quantity) : '');
      fQuantity.value = srcOrder.quantity || 1;
      updateAmountFromInputs();
      // product & status & scheduledDate
      try { document.getElementById('productSelect').value = srcOrder.product || 'Karela Jamun Powder'; } catch(e){}
      fStatus.value = 'open';
      try {
        const today = new Date().toISOString().split('T')[0];
        fScheduledDate.value = today;
      } catch(e) { fScheduledDate.value = ''; }

      // Show Add Order modal
      modalBackdrop.style.display = 'flex';
      modalBackdrop.classList.remove('hidden');

      // Close customer modal
      customerBackdrop.style.display = 'none';
      customerBackdrop.classList.add('hidden');

    } catch (err) {
      console.error('Error pre-filling reorder data', err);
      alert('Failed to pre-fill reorder form.');
    }
  });

  /******** Actions: close/cancel/save external id etc (kept minimal for tellecaller view) ********/
  // (If you have admin-only functions in the admin file, they remain there â€” this file keeps the tellecaller-appropriate handlers.)

  // Wire simple UI filters and search to re-render
  searchInput.addEventListener('input', ()=> renderOrders(searchInput.value));
  filterStatus.addEventListener('change', ()=> renderOrders(searchInput.value));
  filterFrom.addEventListener('change', ()=> renderOrders(searchInput.value));
  filterTo.addEventListener('change', ()=> renderOrders(searchInput.value));

  </script>
</body>
</html>
